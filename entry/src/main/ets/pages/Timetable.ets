import router from '@ohos.router'
import promptAction from '@ohos.promptAction'

type CourseTag = 'å¿…ä¿®' | 'é€‰ä¿®' | 'å®éªŒ' | 'çº¿ä¸Š'

interface CourseItem {
  id: number
  name: string
  place: string
  start: string
  end: string
  section: number
  tag: CourseTag
}

const DAYS: string[] = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥']

function tagBg(tag: CourseTag): string {
  switch (tag) {
    case 'å¿…ä¿®': return '#EAF2FF'
    case 'é€‰ä¿®': return '#E9FBF1'
    case 'å®éªŒ': return '#FFF2E7'
    case 'çº¿ä¸Š': return '#F3E9FF'
    default: return '#F5F6F7'
  }
}

function tagText(tag: CourseTag): string {
  switch (tag) {
    case 'å¿…ä¿®': return '#1677FF'
    case 'é€‰ä¿®': return '#22C55E'
    case 'å®éªŒ': return '#F59E0B'
    case 'çº¿ä¸Š': return '#8B5CF6'
    default: return '#6B7280'
  }
}

const MOCK: Record<number, CourseItem[]> = {
  0: [
    { id: 1, name: 'æ•°æ®ç»“æ„', place: 'A203', start: '08:00', end: '09:35', section: 1, tag: 'å¿…ä¿®' },
    { id: 2, name: 'ç¦»æ•£æ•°å­¦', place: 'B105', start: '10:00', end: '11:35', section: 2, tag: 'å¿…ä¿®' },
    { id: 3, name: 'å½¢åŠ¿ä¸æ”¿ç­–', place: 'çº¿ä¸Š', start: '14:00', end: '15:35', section: 5, tag: 'çº¿ä¸Š' }
  ],
  1: [
    { id: 4, name: 'æ“ä½œç³»ç»Ÿ', place: 'A401', start: '08:00', end: '09:35', section: 1, tag: 'å¿…ä¿®' },
    { id: 5, name: 'æ•°æ®åº“åŸç†', place: 'C210', start: '10:00', end: '11:35', section: 2, tag: 'å¿…ä¿®' }
  ],
  2: [
    { id: 6, name: 'è‹±è¯­ï¼ˆå…­çº§ï¼‰', place: 'D108', start: '10:00', end: '11:35', section: 2, tag: 'é€‰ä¿®' },
    { id: 7, name: 'è½¯ä»¶å·¥ç¨‹å¯¼è®º', place: 'A305', start: '14:00', end: '15:35', section: 5, tag: 'å¿…ä¿®' }
  ],
  3: [
    { id: 8, name: 'åµŒå…¥å¼ç³»ç»Ÿå®éªŒ', place: 'å®éªŒæ¥¼ 2F', start: '13:00', end: '15:35', section: 5, tag: 'å®éªŒ' }
  ],
  4: [
    { id: 9, name: 'ç¼–è¯‘åŸç†', place: 'B209', start: '08:00', end: '09:35', section: 1, tag: 'å¿…ä¿®' },
    { id: 10, name: 'ç®—æ³•è®¾è®¡', place: 'A206', start: '10:00', end: '11:35', section: 2, tag: 'å¿…ä¿®' }
  ],
  5: [],
  6: []
}

@Entry
@Component
struct Timetable {
  @State selectedDay: number = 0
  @State weekNo: number = 16
  @State dateLabel: string = '12/24'
  @State dayList: CourseItem[] = []

  aboutToAppear() {
    this.refreshList()
  }

  private refreshList(): void {
    this.dayList = MOCK[this.selectedDay] ?? []
  }

  private toast(msg: string): void {
    try { promptAction.showToast({ message: msg }) } catch (e) {}
  }

  private back(): void {
    try { router.back() } catch (e) {}
  }

  private openAction(): void {
    this.toast('ç­›é€‰/è®¾ç½®ï¼ˆæ¼”ç¤ºï¼‰')
  }

  private prevWeek(): void {
    if (this.weekNo > 1) this.weekNo--
  }

  private nextWeek(): void {
    this.weekNo++
  }

  private summaryText(): string {
    if (this.dayList.length === 0) return 'ä»Šæ—¥æ— è¯¾ç¨‹å®‰æ’'
    const next = this.dayList[0]
    return `å…± ${this.dayList.length} èŠ‚è¯¾ Â· ä¸‹ä¸€èŠ‚ ${next.start} ${next.name}`
  }

  build() {
    Column() {
      // ================== é¡¶éƒ¨å›ºå®šåŒº ==================
      Column() {
        // é¡¶éƒ¨æ 
        Row() {
          Column() {
            Text('â†')
              .fontSize(18)
              .width(36)
              .height(36)
              .textAlign(TextAlign.Center)
              .backgroundColor('#F3F4F6')
              .borderRadius(18)
          }
          .onClick(() => this.back())

          Text('è¯¾ç¨‹è¡¨')
            .layoutWeight(1)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#111827')
            .textAlign(TextAlign.Center)

          Column() {
            Image($r('app.media.setting'))
              .width(30)
              .height(30)
              .padding(4)
              .backgroundColor('#FFFFFF')
              .borderRadius(19)
              .onClick(() => {
                // TODOï¼šè·³è½¬è®¾ç½®é¡µ
              })
          }
          }
        .width('100%')
        .padding({ left: 18, right: 18, top: 10 })

        // å‘¨æ¬¡/æ—¥æœŸ + åˆ‡æ¢å‘¨
        Row() {
          Column() {
            Text(`æœ¬å‘¨ç¬¬ ${this.weekNo} å‘¨`)
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#111827')
            Text(`Mon ${this.dateLabel}`)
              .fontSize(12)
              .fontColor('#6B7280')
              .margin({ top: 4 })
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Center)

          Row() {
            Text('â€¹')
              .fontSize(18)
              .width(32)
              .height(32)
              .textAlign(TextAlign.Center)
              .backgroundColor('#F3F4F6')
              .borderRadius(16)
              .onClick(() => this.prevWeek())

            Text('â€º')
              .fontSize(18)
              .width(32)
              .height(32)
              .textAlign(TextAlign.Center)
              .backgroundColor('#F3F4F6')
              .borderRadius(16)
              .margin({ left: 10 })
              .onClick(() => this.nextWeek())
          }
        }
        .width('100%')
        .padding({ left: 18, right: 18, top: 8 })

        // æ˜ŸæœŸTab
        Scroll() {
          Row() {
            ForEach(DAYS, (d: string, idx: number) => {
              DayPill({ text: d, active: this.selectedDay === idx })
                .margin({ right: 10 })
                .onClick(() => {
                  this.selectedDay = idx
                  this.refreshList()
                })
            })
          }
          .padding({ left: 18, right: 18, top: 8, bottom: 6 })
        }
        .scrollable(ScrollDirection.Horizontal)
        .scrollBar(BarState.Off)

        // ä»Šæ—¥æ¦‚è§ˆï¼ˆå›ºå®šï¼Œä¸éšåˆ—è¡¨å˜åŒ–ç§»åŠ¨ï¼‰
        Column() {
          Text('ä»Šæ—¥æ¦‚è§ˆ')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#111827')

          Text(this.summaryText())
            .fontSize(12)
            .fontColor('#6B7280')
            .margin({ top: 8 })

          if (this.dayList.length > 0) {
            Text(`ä¸Šè¯¾åœ°ç‚¹ï¼š${this.dayList[0].place}`)
              .fontSize(12)
              .fontColor('#6B7280')
              .margin({ top: 6 })
          }
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#F9FAFB')
        .borderRadius(18)
        .margin({ left: 18, right: 18, top: 10 })
      }

      // ================== ä¸­é—´ï¼šä»…è¯¾ç¨‹åˆ—è¡¨æ»šåŠ¨ï¼ˆé”å®šå®¹å™¨ï¼‰ ==================
      Column() {
        Row() {
          Text('ä»Šæ—¥è¯¾ç¨‹')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#111827')
            .layoutWeight(1)

          Text(DAYS[this.selectedDay])
            .fontSize(12)
            .fontColor('#6B7280')
        }
        .padding({ left: 18, right: 18, top: 12, bottom: 6 })

        // âœ… è¿™é‡Œç”¨ Listï¼Œå æ»¡ä¸­é—´å®¹å™¨ï¼Œè¯¾ç¨‹å¤šå°‘ä¸å½±å“ä¸Šä¸‹å…¶å®ƒå…ƒç´ ä½ç½®
        List() {
          if (this.dayList.length === 0) {
            ListItem() {
              EmptyPanel()
                .margin({ left: 18, right: 18, top: 6 })
            }
          } else {
            ForEach(this.dayList, (c: CourseItem) => {
              ListItem() {
                CourseCard({ item: c })
                  .margin({ left: 18, right: 18, top: 10 })
                  .onClick(() => this.toast(`è¿›å…¥ã€Œ${c.name}ã€è¯¦æƒ…ï¼ˆæ¼”ç¤ºï¼‰`))
              }
            })
          }
          // åº•éƒ¨ç•™ç‚¹ç©ºï¼Œé¿å…æœ€åä¸€ä¸ªå¡ç‰‡è´´åˆ°åº•éƒ¨æ 
          ListItem() {
            Column() {
              Blank().height(90)
            }
          }

        }
        .width('100%')
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
      .layoutWeight(1)

      // ================== åº•éƒ¨å›ºå®šæ“ä½œæ ï¼ˆé”å®šä¸åŠ¨ï¼‰ ==================
      Row() {
        Button('+ æ·»åŠ è¯¾ç¨‹')
          .height(44)
          .backgroundColor('#1677FF')
          .fontColor(Color.White)
          .borderRadius(12)
          .layoutWeight(1)
          .onClick(() => this.toast('æ·»åŠ è¯¾ç¨‹ï¼ˆæ¼”ç¤ºï¼‰'))

        Button('å¯¼å…¥/å¯¼å‡º')
          .height(44)
          .backgroundColor('#F3F4F6')
          .fontColor('#111827')
          .borderRadius(12)
          .layoutWeight(1)
          .margin({ left: 12 })
          .onClick(() => this.toast('å¯¼å…¥/å¯¼å‡ºï¼ˆæ¼”ç¤ºï¼‰'))
      }
      .width('100%')
      .padding({ left: 18, right: 18, top: 10, bottom: 12 })
      .backgroundColor('#FFFFFF')
      .border({ width: { top: 1 }, color: '#EEF0F2' })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
  }
}

@Component
struct DayPill {
  @Prop text: string
  @Prop active: boolean

  build() {
    Text(this.text)
      .fontSize(12)
      .fontColor(this.active ? '#1677FF' : '#6B7280')
      .padding({ left: 14, right: 14, top: 8, bottom: 8 })
      .backgroundColor(this.active ? '#EAF2FF' : '#F3F4F6')
      .borderRadius(18)
  }
}

@Component
struct CourseCard {
  @Prop item: CourseItem

  build() {
    Row() {
      // å·¦ä¾§èŠ‚æ¬¡
      Column() {
        Text(`${this.item.section}`)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#111827')
      }
      .width(44)
      .height(44)
      .backgroundColor('#FFFFFF')
      .borderRadius(14)
      .alignItems(HorizontalAlign.Center)
      .justifyContent(FlexAlign.Center)

      // âœ… å³ä¾§ä¿¡æ¯ï¼šå¼ºåˆ¶é å·¦
      Column() {
        Row() {
          Text(this.item.name)
            .width('100%')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#111827')
            .textAlign(TextAlign.Start)

          Text('â€º')
            .fontSize(20)
            .fontColor('#9CA3AF')
        }
        .width('100%')

        Text(`${this.item.start}-${this.item.end} Â· ${this.item.place}`)
          .width('100%')
          .fontSize(12)
          .fontColor('#6B7280')
          .textAlign(TextAlign.Start)
          .margin({ top: 6 })

        Text(this.item.tag)
          .fontSize(11)
          .fontColor(tagText(this.item.tag))
          .padding({ left: 10, right: 10, top: 4, bottom: 4 })
          .backgroundColor('#FFFFFF')
          .borderRadius(10)
          .margin({ top: 8 })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start) // âœ… å…³é”®ï¼šæ•´ä½“é å·¦
      .margin({ left: 12 })
      .layoutWeight(1)
    }
    .padding(16)
    .backgroundColor(tagBg(this.item.tag))
    .borderRadius(18)
    .shadow({ radius: 10, color: '#12000000', offsetX: 0, offsetY: 6 })
  }
}

@Component
struct EmptyPanel {
  build() {
    Column() {
      Text('ğŸ‰').fontSize(28)
      Text('ä»Šå¤©æ²¡æœ‰è¯¾ç¨‹')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#111827')
        .margin({ top: 8 })
      Text('å¥½å¥½ä¼‘æ¯ä¸€ä¸‹ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹æ·»åŠ è¯¾ç¨‹')
        .fontSize(12)
        .fontColor('#6B7280')
        .margin({ top: 6 })
    }
    .width('100%')
    .padding(18)
    .backgroundColor('#F9FAFB')
    .borderRadius(18)
    .alignItems(HorizontalAlign.Center)
  }
}
