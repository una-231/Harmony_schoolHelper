import router from '@ohos.router'
import promptAction from '@ohos.promptAction'

interface Feature {
  title: string
  subTitle: string
  bg: string
  type: 'class' | 'notice' | 'guide' | 'mine'
  to: string
}
const FEATURES: Feature[] = [
  { title: 'è¯¾ç¨‹è¡¨', subTitle: 'æŸ¥çœ‹ä»Šæ—¥è¯¾ç¨‹', bg: '#EAF2FF', type: 'class', to: 'pages/Timetable' },
  { title: 'æ ¡å›­å…¬å‘Š', subTitle: 'æœ€æ–°é€šçŸ¥', bg: '#E9FBF1', type: 'notice', to: 'pages/Notices' },
  { title: 'æ ¡å›­å¯¼è§ˆ', subTitle: 'è·¯çº¿ä¸Žåœ°ç‚¹', bg: '#FFF2E7', type: 'guide', to: 'pages/Guide' },
  { title: 'ä¸ªäººä¸­å¿ƒ', subTitle: 'è´¦å·ä¸Žè®¾ç½®', bg: '#F3E9FF', type: 'mine', to: 'pages/Profile' }
]

@Entry
@Component
struct Index {
  private features: Feature[] = FEATURES
  private searchIcon: Resource = $r('app.media.search')

  aboutToAppear(): void {
    // ç™»å½•æ€æ‹¦æˆªï¼ˆé¢„è§ˆå™¨/æ¨¡æ‹Ÿå™¨å¯èƒ½ä¸æ”¯æŒè·¯ç”±ï¼Œtry ä¸€ä¸‹æ›´ç¨³ï¼‰
    try {
      if (AppStorage.get('isLogin') !== true) {
        router.replaceUrl({ url: 'pages/Login' })
      }
    } catch (e) {}
  }

  private go(url: string): void {
    try {
      router.pushUrl({ url })
    } catch (e) {}
  }

  private toast(msg: string): void {
    try {
      promptAction.showToast({ message: msg })
    } catch (e) {}
  }

  build() {
    Column() {
      // ===== é¡¶éƒ¨æ ï¼šæ ‡é¢˜ä¸¥æ ¼å±…ä¸­ï¼Œæœç´¢å›ºå®šå³ä¾§ =====
      Row() {
        // å·¦ä¾§å ä½ï¼ˆå’Œå³ä¾§æŒ‰é’®åŒå®½ï¼‰ï¼Œç”¨äºŽè®©æ ‡é¢˜çœŸæ­£å±…ä¸­
        Blank()
          .width(36)
          .height(36)

        // ä¸­é—´æ ‡é¢˜åŒºåŸŸï¼šå æ»¡å‰©ä½™ç©ºé—´ï¼Œæ–‡å­—å±…ä¸­
        Text('æ ¡å›­ç”Ÿæ´»åŠ©æ‰‹')
          .layoutWeight(1)
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1F2937')
          .textAlign(TextAlign.Center)

        // å³ä¾§æœç´¢æŒ‰é’®
        Column() {
          Image(this.searchIcon)
            .width(22)
            .height(22)
        }
        .width(36)
        .height(36)
        .backgroundColor(Color.White)
        .borderRadius(18)
        .alignItems(HorizontalAlign.Center)
        .justifyContent(FlexAlign.Center)
        .onClick(() => this.toast('æœç´¢ï¼ˆæ¼”ç¤ºï¼‰'))
      }
      .width('100%')
      .padding({ left: 18, right: 18, top: 18 })
      // ====== å†…å®¹åŒºï¼ˆå¡ç‰‡ï¼‰ ======
      Column() {
        // ä»Šæ—¥æé†’å¡ï¼šæ›´çŽ°ä»£çš„å±‚çº§
        Row() {
          Column() {
            Text('ä»Šæ—¥æé†’')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#111827')

            Text('è¯·åŠæ—¶æŸ¥çœ‹å…¬å‘Šä¸Žè¯¾ç¨‹å˜æ›´é€šçŸ¥')
              .fontSize(12)
              .fontColor('#6B7280')
              .margin({ top: 6 })
          }
          .margin({ left: 12 })
        }
        .padding(16)
        .backgroundColor('#fffffcfc')
        .borderRadius(18)

        // åŠŸèƒ½å¡ç‰‡åˆ—è¡¨
        Column() {
          ForEach(this.features, (item: Feature) => {
            FeatureCard({
              title: item.title,
              subTitle: item.subTitle,
              bg: item.bg,
              type: item.type,
              to: item.to
            })
              .margin({ top: 12 })
          })
        }
        .margin({ top: 14 })
      }
      .padding({ left: 18, right: 18, top: 16 })
      .layoutWeight(1)

      // ====== åº•éƒ¨å¯¼èˆª ======
      BottomNav({ current: 0 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
  }
}

@Component
struct FeatureCard {
  @Prop title: string
  @Prop subTitle: string
  @Prop bg: string
  @Prop type: string
  @Prop to: string

  @State pressed: boolean = false

  private getIcon(): Resource {
    switch (this.type) {
      case 'class':
        return $r('app.media.class')
      case 'notice':
        return $r('app.media.notice')
      case 'guide':
        return $r('app.media.guide')
      case 'mine':
        return $r('app.media.mine')
      default:
        return $r('app.media.class')
    }
  }

  private go(): void {
    try {
      router.pushUrl({ url: this.to })
    } catch (e) {}
  }

  build() {
    Row() {
      // å·¦ä¾§å›¾æ ‡ï¼šç™½åº•åœ†è§’å®¹å™¨ï¼ˆçŽ°ä»£ï¼‰
      Column() {
        Image(this.getIcon())
          .width(24)
          .height(24)
      }
      .width(44)
      .height(44)
      .backgroundColor('#FFFFFF')
      .borderRadius(14)
      .alignItems(HorizontalAlign.Center)
      .justifyContent(FlexAlign.Center)

      Column() {
        Text(this.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#111827')

        Text(this.subTitle)
          .fontSize(12)
          .fontColor('#6B7280')
          .margin({ top: 6 })
      }
      .margin({ left: 12 })
      .layoutWeight(1)

      Text('â€º')
        .fontSize(22)
        .fontColor('#9CA3AF')
        .margin({ right: 2 })
    }
    .padding(16)
    .height(80)
    .backgroundColor(this.bg)
    .borderRadius(18)
    .shadow({ radius: 10, color: '#12000000', offsetX: 0, offsetY: 6 })
    .scale({ x: this.pressed ? 0.985 : 1, y: this.pressed ? 0.985 : 1 })
    .onTouch((e) => {
      if (e.type === TouchType.Down) this.pressed = true
      if (e.type === TouchType.Up) {
        this.pressed = false
        this.go()
      }
      if (e.type === TouchType.Cancel) this.pressed = false
    })
  }
}

@Component
struct BottomNav {
  @Prop current: number

  private go(index: number): void {
    if (index === this.current) return
    const map: Record<number, string> = {
      0: 'pages/Index',
      1: 'pages/Timetable',
      2: 'pages/Notices',
      3: 'pages/Guide',
      4: 'pages/Profile'
    }
    try {
      router.replaceUrl({ url: map[index] })
    } catch (e) {}
  }

  build() {
    Row() {
      Column() {
        NavItem({ text: 'é¦–é¡µ', icon: 'ðŸ ', active: this.current === 0 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
      .onClick(() => this.go(0))

      Column() {
        NavItem({ text: 'è¯¾ç¨‹', icon: 'ðŸ“š', active: this.current === 1 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
      .onClick(() => this.go(1))

      Column() {
        NavItem({ text: 'å…¬å‘Š', icon: 'ðŸ“¢', active: this.current === 2 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
      .onClick(() => this.go(2))

      Column() {
        NavItem({ text: 'å¯¼è§ˆ', icon: 'ðŸ§­', active: this.current === 3 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
      .onClick(() => this.go(3))

      Column() {
        NavItem({ text: 'æˆ‘çš„', icon: 'ðŸ‘¤', active: this.current === 4 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
      .onClick(() => this.go(4))
    }
    .width('100%')
    .padding({ top: 8, bottom: 10 })
    .backgroundColor('#FFFFFF')
    .border({ width: { top: 1 }, color: '#F0F0F0' })
  }
}


@Component
struct NavItem {
  @Prop text: string
  @Prop icon: string
  @Prop active: boolean

  build() {
    Column() {
      Text(this.icon).fontSize(18)
      Text(this.text)
        .fontSize(12)
        .fontColor(this.active ? '#1677FF' : '#6B7280')
        .margin({ top: 4 })
    }
    .alignItems(HorizontalAlign.Center)
  }
}
